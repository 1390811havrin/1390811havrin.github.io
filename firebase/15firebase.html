<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

		<!-- Bootstrap CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

		<!-- Optional theme -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

		<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
		<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
		<!--[if lt IE 9]>
		<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
		<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
		<![endif]-->

		<title>Firebase</title>
	</head>

	<body>

		<div class="container">
			<h2>Guestbook</h2>
            
            <form id="inputForm" role="form"> 
               
                <div class="form-group"> 
                    <label for="guestFirstNameTB">Enter your first name: </label>
                    <input type="text" class="form-control" id="guestFirstNameTB" placeholder="Guest First Name"/> 
                </div>	 
                
                <div class="form-group"> 
                    <label for="guestMiddleNameTB">Enter your middle name: </label>
                    <input type="text" class="form-control" id="guestMiddleNameTB" placeholder="Guest Middle Name"/> 
                </div>	 

                <div class="form-group"> 
                    <label for="guestLastNameTB">Enter your last name: </label>
                    <input type="text" class="form-control" id="guestLastNameTB" placeholder="Guest Last Name"/> 
                </div>	 

                <div class="form-group"> 
                    <label for="guestEmailTB">Enter your email: </label>
                    <input type="text" class="form-control" id="guestEmailTB" placeholder="Guest Email"/> 
                </div>	 

                <div class="form-group"> 
                    <label for="guestPhoneTB">Enter your phone number: </label>
                    <input type="text" class="form-control" id="guestPhoneTB" placeholder="Guest Phone Number"/> 
                </div>	 

                <button type="button" id="addGuestButton" class="btn btn-default">
                    Add your information to the guestbook 
                </button>
                
                <button type="button" id="clearGuestbookButton" class="btn btn-default">
                    Clear the guestbook 
                </button>                
            </form>
            
            <h2>Guests</h2>
            <!-- and empty list to hold guests -->
            <ul id="guestList">                
            </ul>

		</div>


		<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		<!-- Latest compiled and minified JavaScript -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

		<!-- firebase library -->
		<script src="https://cdn.firebase.com/js/client/2.3.2/firebase.js"></script>
		
		<script>
		
			$(document).ready(function() {
				                
				//get a reference to our firebase right away when the page loads
				var myFirebaseRef = new Firebase("https://mm-guestbook.firebaseio.com/");
                
                //ask for a continuous read of the root of the firebase with on("child_added")
                
                //1. when the page is loaded the first time the function will be called once
                //for each existing item
                //2. any time the data changes, you will get sent a snapshot with
                //only the newly added data
				myFirebaseRef.orderByChild("name/lastName").on("child_added", function(snapshot, previousNeighborId) {

                    //previousNeighborId is the id of the previous element (or null if this is
                    //the first item in the list) for ordering purposes
                    
                    //get the guest 
                    var guest = snapshot.val();
                                        
                    //create a new list item for the guest
                    var guestLi = $("<li>" + guest.name.firstName + " " + guest.name.lastName + "</li>")

                    //set the id for each guest li
                    guestLi.attr("id", snapshot.key());

                    //if there was a previous neighbor
                    if(previousNeighborId !== null) {
                        
                        //get the li of the previous one
                        var previousGuestLi = $("#" + previousNeighborId);
                        
                        //add the new li after the previous one
                        previousGuestLi.after(guestLi);        
                        
                    } else { //no previous neighbor
                        
                        //grab the guestlist ul
                        var guestList = $("#guestList");
                        
                        //add the first item to the list
                        guestList.append(guestLi);
                    }
				});

                
                //ask for a continuous read of the root of the firebase with on("child_changed")

                //this is called when a guest is changed, you get a snapshot with only
                //the changed 
                myFirebaseRef.orderByChild("name/lastName").on("child_changed", function(snapshot, previousNeighborId) {
                    
                    //get the guest that has changed
                    var changedGuest = snapshot.val();

                    //remove the li with the old values
                    $("#" + snapshot.key()).remove();
                    
                    //create a new list item for the update guest
                    var guestLi = $("<li>" + changedGuest.name.firstName + " " + changedGuest.name.lastName + "</li>")

                    //set the id for each guest li
                    guestLi.attr("id", snapshot.key());

                    //get the previous neighbor list item
                    var previousNeighborLi = $("#" + previousNeighborId);

                    //add the changed name to the 
                    previousNeighborLi.after(guestLi);                                    
                });

                //ask for a continuous read of the root of the firebase with on("child_removed")
                myFirebaseRef.on("child_removed", function(snapshot) {
                    
                    //remove the li with the deleted guest's id
                    $("#" + snapshot.key()).remove();
                    
                });

                
                
                //set up a button handler to add a guest to the guestbook
                $("#addGuestButton").on("click", function(e) {
                 
                    //get the guest name
                    var guestFirstName = $("#guestFirstNameTB").val();
                    var guestMiddleName = $("#guestMiddleNameTB").val();
                    var guestLastName = $("#guestLastNameTB").val();
                    var guestEmail = $("#guestEmailTB").val();
                    var guestPhone = $("#guestPhoneTB").val();
                    
                    //add the key/value pair off of the root
                    
                    //you can pass in an even more complex object and it will add 
                    //all of the members and sub-members
                    myFirebaseRef.push({name: {firstName: guestFirstName, middleName: guestMiddleName, lastName: guestLastName}, email: guestEmail, phone: guestPhone});
                    
                    //clear the text boxes to get ready for the next guest
                    $("#guestFirstNameTB").val("");
                    $("#guestMiddleNameTB").val("");
                    $("#guestLastNameTB").val("");
                    $("#guestEmailTB").val("");
                    $("#guestPhoneTB").val("");
                    
                });
                
                //set up a button handler
                $("#clearGuestbookButton").on("click", function(e) {
                    //to clear the entire firebase set the root to null
                    myFirebaseRef.set(null);    
                });

			});

		</script>
	</body>
</html>